<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Glimmer Launcher</title>
    <script src="capacitor.js"></script>
    <style>
        /* ... (CSS Styles remain the same) ... */
    </style>
</head>
<body>
    <div class="launcher-container">
        <h1 class="title">Glimmer</h1>
        <div class="settings-group">
            <div class="setting-item">
                <label for="server-select">Server:</label>
                <select id="server-select">
                    <option value="1">Server 1</option>
                    <option value="2">Server 2</option>
                </select>
            </div>
            <!-- NEW: Run in Background Toggle -->
            <div class="setting-item">
                <label>Run in Background:</label>
                <label class="switch">
                    <input type="checkbox" id="background-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label>Keep Screen On:</label>
                <label class="switch">
                    <input type="checkbox" id="keep-awake-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label>Idle Alert:</label>
                <label class="switch">
                    <input type="checkbox" id="idle-alert-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label>PM Alert:</label>
                <label class="switch">
                    <input type="checkbox" id="pm-alert-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label>Low Health Alert:</label>
                <label class="switch">
                    <input type="checkbox" id="health-alert-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <button id="play-button" class="play-button">Play Now</button>
        <button id="test-notification-button">Test Notification</button>
    </div>
    <script type="module">
        import GlimmerPlugin from './glimmer-plugin.js';

        // Capacitor 7 Modernization: Accessing plugins via the exported registry
        // capacitorExports is defined globally by capacitor.js
        const { registerPlugin } = capacitorExports;
        
        // Register standard plugins using the modern approach
        const KeepAwake = registerPlugin('KeepAwake');
        const Preferences = registerPlugin('Preferences');
        
        window.addEventListener('DOMContentLoaded', () => {
            // const { KeepAwake, Preferences } = Capacitor.Plugins; // OLD WAY

            const serverSelect = document.getElementById('server-select');
            const backgroundToggle = document.getElementById('background-toggle'); // NEW
            const keepAwakeToggle = document.getElementById('keep-awake-toggle');
            const idleAlertToggle = document.getElementById('idle-alert-toggle');
            const pmAlertToggle = document.getElementById('pm-alert-toggle');
            const healthAlertToggle = document.getElementById('health-alert-toggle');
            const playButton = document.getElementById('play-button');

            const servers = {
                '1': 'https://server1.highspell.com:8888',
                '2': 'https://server2.highspell.com:8888',
            };

            const applyWakelock = async () => {
                // KeepAwake prevents the screen from turning off while the app is open.
                if (keepAwakeToggle.checked) await KeepAwake.keepAwake();
                else await KeepAwake.allowSleep();
            };

            const saveAllSettings = async () => {
                await Preferences.set({ key: 'glimmer_server', value: serverSelect.value });
                // NEW: Save the background setting (Key must match MainActivity.java)
                await Preferences.set({ key: 'glimmer_runInBackground', value: String(backgroundToggle.checked) });
                await Preferences.set({ key: 'glimmer_wakelock', value: String(keepAwakeToggle.checked) });
                await Preferences.set({ key: 'glimmer_idleAlert', value: String(idleAlertToggle.checked) });
                await Preferences.set({ key: 'glimmer_pmAlert', value: String(pmAlertToggle.checked) });
                await Preferences.set({ key: 'glimmer_healthAlert', value: String(healthAlertToggle.checked) });
            };

            const loadSettings = async () => {
                const { value: server } = await Preferences.get({ key: 'glimmer_server' });
                if (server) serverSelect.value = server;

                // NEW: Load the background setting
                const { value: runInBackground } = await Preferences.get({ key: 'glimmer_runInBackground' });
                if (runInBackground !== null) backgroundToggle.checked = (runInBackground === 'true');

                const { value: wakelock } = await Preferences.get({ key: 'glimmer_wakelock' });
                if (wakelock !== null) keepAwakeToggle.checked = (wakelock === 'true');

                const { value: idleAlert } = await Preferences.get({ key: 'glimmer_idleAlert' });
                if (idleAlert !== null) idleAlertToggle.checked = (idleAlert === 'true');

                const { value: pmAlert } = await Preferences.get({ key: 'glimmer_pmAlert' });
                if (pmAlert !== null) pmAlertToggle.checked = (pmAlert === 'true');
                
                const { value: healthAlert } = await Preferences.get({ key: 'glimmer_healthAlert' });
                if (healthAlert !== null) healthAlertToggle.checked = (healthAlert === 'true');

                await applyWakelock();
            };
            
            keepAwakeToggle.addEventListener('change', applyWakelock);

            playButton.addEventListener('click', async () => {
                await saveAllSettings();
                const selectedServerId = serverSelect.value;
                const selectedServerUrl = servers[selectedServerId];
                GlimmerPlugin.loadGame({ serverId: selectedServerId, serverUrl: selectedServerUrl });
            });

            loadSettings();
        });
    </script>
    <script>
    document.getElementById('test-notification-button').addEventListener('click', () => {
        if (window.GlimmerNative && window.GlimmerNative.notify) {
            console.log("Sending a test notification...");
            window.GlimmerNative.notify("Test Title", "This is a test notification.");
        } else {
            console.error("GlimmerNative bridge not found!");
        }
    });
</script>
</body>
</html>